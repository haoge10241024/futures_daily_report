# 期货日报生成系统（AI赋能版）

### 1. **📊 8大专业分析维度**

| 维度 | 权重 | 分析内容 | 数据来源 |
|------|------|---------|---------|
| **1. 技术面分析** | 20% | MA5/10/20、MACD、RSI、布林带、支撑阻力 | 计算得出 |
| **2. 基本面分析** | 15% | 库存、仓单、供需、基差、期限结构 | Serper搜索 |
| **3. 资金面分析** | 15% | 持仓席位、主力动向、多空力量 | Serper搜索 |
| **4. 产业链分析** | 10% | 上下游价格、产业链传导、生产利润 | Serper搜索 |
| **5. 政策面分析** | 10% | 国家政策、行业政策、政策影响 | Serper搜索 |
| **6. 进出口分析** | 10% | 进口量、出口量、海关数据、国际贸易 | Serper搜索 |
| **7. 市场情绪** | 10% | 新闻舆情、投资者情绪、市场热度 | Serper搜索 |
| **8. 风险因素** | 10% | 主要风险、不确定性、潜在变化 | 综合判断 |

### 2. **🔍 数据获取机制**

#### 技术指标计算（本地计算）

```python
def calculate_technical_indicators(market_data_df):
    """计算技术指标（MA、MACD、RSI、布林带）"""
    
    # 计算均线
    ma5 = close_prices.rolling(window=5).mean()
    ma10 = close_prices.rolling(window=10).mean()
    ma20 = close_prices.rolling(window=20).mean()
    
    # 计算MACD
    exp1 = close_prices.ewm(span=12, adjust=False).mean()
    exp2 = close_prices.ewm(span=26, adjust=False).mean()
    macd = exp1 - exp2
    signal = macd.ewm(span=9, adjust=False).mean()
    
    # 计算RSI
    delta = close_prices.diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
    rsi = 100 - (100 / (1 + gain / loss))
    
    # 计算布林带
    upper_band = ma20 + (std20 * 2)
    lower_band = ma20 - (std20 * 2)
```

**输出示例：**
```
当前价格：11325.0元
MA5：11450.0元
MA10：11520.0元
MA20：11600.0元
MACD：-15.5 (信号线：-12.3)
RSI(14)：42.5
布林带：上轨11800.0元 / 下轨11400.0元
价格位置：下轨附近
```

#### 8大维度专业数据搜索（联网获取）

```python
def search_professional_data(commodity, serper_key, target_date):
    """搜索8大维度专业数据"""
    
    professional_keywords = {
        '库存仓单': [
            f"{commodity} 仓单 {target_date}",
            f"{commodity} 库存 {target_date}",
            f"{commodity} 交易所仓单"
        ],
        '基差分析': [
            f"{commodity} 基差 {target_date}",
            f"{commodity} 期现价差",
            f"{commodity} 现货价格 期货价格"
        ],
        '期限结构': [
            f"{commodity} 月差 {target_date}",
            f"{commodity} 远近月价差",
            f"{commodity} 跨期价差"
        ],
        '持仓席位': [
            f"{commodity} 持仓席位 {target_date}",
            f"{commodity} 主力持仓",
            f"{commodity} 多空持仓"
        ],
        '供需分析': [
            f"{commodity} 产量 {target_date}",
            f"{commodity} 消费量",
            f"{commodity} 供需平衡表"
        ],
        '产业链': [
            f"{commodity} 产业链 价格",
            f"{commodity} 上下游",
            f"{commodity} 生产利润"
        ],
        '进出口': [
            f"{commodity} 进口量 {target_date}",
            f"{commodity} 出口量",
            f"{commodity} 海关数据"
        ],
        '宏观政策': [
            f"{commodity} 政策 {target_date}",
            f"{commodity} 行业政策",
            f"{commodity} 国家政策"
        ]
    }
    
    # 通过Serper API搜索每个维度
    # 每个维度搜索前2个关键词
    # 每个关键词取前2条结果
    # 总计最多32条专业数据
```

### 3. **🤖 AI Prompt升级**

#### 8大维度系统分析框架

```python
【撰写要求 - 8大维度专业分析框架】⭐核心

请撰写一段300-400字的专业主要观点，必须基于以下8大维度进行系统分析：

1. **技术面分析**（权重20%）
   - 均线系统：当前价格与MA5/MA10/MA20的关系
   - 技术指标：MACD、RSI的信号
   - 关键位：支撑位、压力位、布林带位置

2. **基本面分析**（权重15%）
   - 供需格局：根据提供的库存、仓单、供需数据判断
   - 基差：期现价差水平及趋势
   - 期限结构：远近月价差及升贴水情况

3. **资金面分析**（权重15%）
   - 持仓席位：主力机构动向（如有数据）
   - 多空力量：根据价格走势和持仓判断

4. **产业链分析**（权重10%）
   - 上下游：产业链价格传导
   - 利润：生产利润和贸易利润

5. **政策面分析**（权重10%）
   - 国家政策：相关政策对市场的影响
   - 行业政策：行业规范和标准

6. **进出口分析**（权重10%）
   - 进口量：海关数据及趋势
   - 出口量：国际贸易情况

7. **市场情绪**（权重10%）
   - 新闻舆情：市场热点和关注度
   - 投资者情绪：恐慌或贪婪指数

8. **风险因素**（权重10%）
   - 主要风险：列举2-3个关键风险点
   - 不确定性：市场可能的变化

【分析逻辑】
价格表现 → 技术面支撑 → 基本面驱动 → 资金面验证 → 产业链印证 → 政策面影响 → 综合判断 → 操作建议 → 风险提示
```

#### 关键改进点

1. **明确权重** - 每个维度的分析权重清晰
2. **逻辑链条** - 从价格到风险的完整分析链
3. **专业术语** - 要求使用"多头动能"、"基差走强"、"期限结构倒挂"等
4. **可操作性** - 必须给出明确价格区间和止损位

---

### 4. **🔄 完整工作流程**

```
用户点击"AI生成主要观点（专业版）"
        ↓
【第1步：计算技术指标】(3秒)
   从session_state获取历史数据
   计算MA5/10/20、MACD、RSI、布林带
   ✅ 显示：技术指标计算完成
        ↓
【第2步：搜索8大维度数据】(20-30秒)
   通过Serper API搜索：
   - 库存仓单（2个关键词×2条结果）
   - 基差分析（2×2）
   - 期限结构（2×2）
   - 持仓席位（2×2）
   - 供需分析（2×2）
   - 产业链（2×2）
   - 进出口（2×2）
   - 宏观政策（2×2）
   总计：最多32条专业数据
   ✅ 显示：专业数据获取完成：8个维度
        ↓
【第3步：AI综合分析】(5-10秒)
   将以下数据传入DeepSeek AI：
   - 价格数据（日盘+夜盘）
   - 技术指标（8项指标）
   - 商品新闻（10条）
   - 8大维度专业数据（32条）
   
   AI基于8大维度系统分析
   输出300-400字专业观点
   ✅ 显示：主要观点生成完成！基于8大维度专业分析
        ↓
【完成】
   观点显示在文本框
   用户可手动编辑
```

## 🔧 技术实现细节

### 1. 技术指标计算

**代码位置：** 第430-480行

**特点：**
- 使用pandas进行矢量化计算
- 支持MA5/10/20、MACD、RSI、布林带
- 自动判断数据是否充足（至少20根K线）
- 返回标准化的字典格式

**示例输出：**
```python
{
    'ma5': 11450.0,
    'ma10': 11520.0,
    'ma20': 11600.0,
    'macd': -15.5,
    'macd_signal': -12.3,
    'macd_hist': -3.2,
    'rsi': 42.5,
    'upper_band': 11800.0,
    'lower_band': 11400.0,
    'current_price': 11325.0,
    'price_position': '下轨附近'
}
```

### 2. 8大维度数据搜索

**代码位置：** 第288-391行

**搜索策略：**
```
每个维度：2个关键词
每个关键词：前2条结果
总计：8维度 × 2关键词 × 2结果 = 最多32条数据

API调用次数：8维度 × 2关键词 = 16次
总耗时：约20-30秒（含sleep 0.5秒）
```

**数据结构：**
```python
{
    '库存仓单': [
        {
            'title': '生猪仓单环比增加3000吨',
            'content': '交易所数据显示...',
            'url': 'https://...',
            'source': 'exchange.com',
            'date': '2025-10-10',
            'category': '库存仓单'
        },
        ...
    ],
    '基差分析': [...],
    ...
}
```

### 3. AI Prompt设计

**代码位置：** 第603-687行

**核心特点：**
1. **5重约束** - 强化真实性保障
2. **8大维度** - 系统性分析框架
3. **权重明确** - 技术20%、基本15%...
4. **逻辑链条** - 价格→技术→基本→资金→...
5. **引用规范** - 上标[1][2][3]格式

**Token配置：**
```python
{
    "temperature": 0.2,  # 低温度，高准确性
    "max_tokens": 1200   # 支持300-400字输出
}
```

## 🚀 使用指南

### 完整操作流程

```
1. 启动系统
   streamlit run 期货日报_AI增强专业版.py

2. 输入基本信息
   - 选择日期：2025-10-10
   - 品种名称：生猪
   - 合约代码：LH2511

3. 生成K线图
   - 点击"生成K线图"
   - 等待3-5秒
   - ✅ K线图显示
   - ✅ 新闻获取完成

4. AI生成主要观点（专业版）⭐
   - 点击"AI生成主要观点（专业版）"
   
   【第1步】计算技术指标
   - 进度：📊 正在计算技术指标...
   - 结果：✅ 技术指标计算完成：MA5=11450元, RSI=42.5
   
   【第2步】搜索8大维度数据
   - 进度：🔍 正在搜索8大维度专业数据...
   - 耗时：20-30秒
   - 结果：✅ 专业数据获取完成：8个维度 - 库存仓单、基差分析、期限结构等
   
   【第3步】AI综合分析
   - 进度：🤖 AI正在进行8大维度专业分析并生成观点...
   - 耗时：5-10秒
   - 结果：✅ 主要观点生成完成！基于8大维度专业分析
   
   总耗时：30-45秒

5. 查看生成的观点
   - 自动显示在文本框
   - 可手动编辑调整
   - 包含8大维度分析

6. 生成完整日报
   - 点击"生成完整日报"
   - Word文档自动保存
   - 包含附录：参考文献
```

### 注意事项

1. **网络要求**
   - 必须连接互联网
   - Serper API需要17次调用
   - 建议网络稳定环境下使用

2. **数据可用性**
   - 部分品种数据可能不全
   - 如某维度数据缺失，AI会说明"该维度数据暂缺"
   - 不影响其他维度分析

3. **API限制**
   - Serper API：免费额度2500次
   - 17次/报告 ≈ 147份报告/免费额度
   - 建议合理使用

4. **耗时预期**
   - 首次使用可能较慢（30-45秒）
   - 主要时间用于搜索专业数据
   - 结果质量显著提升，值得等待

---

## 📝 输出示例

### 二、主要观点（完整示例）

```
【技术面】截至2025年10月10日收盘，生猪期货主力合约LH2511收于11325元，
跌破MA5(11450元)、MA10(11520元)和MA20(11600元)三道均线，形成空头
排列。MACD指标(-15.5)持续下行且远离信号线(-12.3)，柱状图扩大至-3.2，
显示下跌动能增强。RSI(14)为42.5，处于弱势区间但未超卖。价格临近布林带
下轨(11400元)，短期存在技术性反弹需求，但中期趋势偏空。

【基本面】库存维度，社会库存环比上升8%[1]，交易所仓单增加3000吨至
15000吨[2]，供应压力持续释放。基差方面，期现价差收窄至-200元/吨[3]，
显示现货市场更加疲弱。期限结构呈现Back结构[4]，远月11月合约较近月9月
合约贴水150元/吨，反映市场中长期看空预期。供需平衡表显示三季度产能同比
增加10%，但消费萎缩8%，供过于求格局短期难改[5]。

【资金面】持仓席位数据显示[6]，主力多头持仓环比减少5000手至32000手，
空头增加8000手至44000手，净空持仓达12000手，主力资金做空意愿强烈，
市场多空分歧明显倾向空方。

【产业链】上游玉米价格下跌2%至2350元/吨[7]，豆粕价格持平，饲料成本
下降，养殖利润理论改善。但下游需求端，猪肉消费持续低迷[8]，屠宰企业
开工率仅65%，屠宰利润压缩至-50元/头，产业链传导整体偏空。

【政策面】农业农村部10月8日发布《生猪产能调控指导意见》[9]，鼓励
适度去产能，优化产业结构，但政策传导至市场需要时间，短期影响有限。

【进出口】海关总署数据显示[10]，9月猪肉进口量为45万吨，同比增加15%，
进口猪肉价格较国内低20%，外部供应增加进一步施压国内价格。

【市场情绪】新闻舆情整体偏空，市场关注度相比前期有所下降，投资者
情绪谨慎，避险情绪上升。

【综合判断】技术面呈现空头排列，基本面供过于求格局明显，资金面主力
做空主导，产业链利润恶化，政策支持短期难见效，进出口压力持续，市场
多维度共振向下。短期价格仍有下行压力，关键支撑位在11300元，若跌破
可能下探11000元整数关口。

【操作建议】在11400-11500元区间逢高试空，目标11200-11300元，止损
11600元。激进者可在11300元下方止损。稳健者等待反弹至11500元上方再
空。

【风险提示】需警惕以下风险：1）政策性去产能超预期导致供应快速收缩；
2）消费端突然好转（节假日、猪价倒逼需求回升）；3）进口受阻或外部
供应中断。
```

**字数统计：** 约380字  
**引用数量：** 10条  
**覆盖维度：** 8/8（100%）  
**专业评级：** ⭐⭐⭐⭐⭐

---

## 🎖️ 版本总结

1. **✅ 系统性** - 8大维度完整覆盖
2. **✅ 数据驱动** - 技术指标+32条专业数据+10条新闻
3. **✅ 真实可靠** - 所有数据联网获取，实时更新
4. **✅ 专业深度** - 300-400字深度分析，机构级水平
5. **✅ 可追溯性** - 所有数据标注来源，附录列出链接
6. **✅ 可操作性** - 明确价格区间、止损位、风险点

## 📞 技术支持

如有问题或建议，欢迎联系：
- **作者：** 7haoge
- **邮箱：** 953534947@qq.com


**🔥 机构级分析框架，打造专业的期货日报生成系统！**

Created by 7haoge (953534947@qq.com)

