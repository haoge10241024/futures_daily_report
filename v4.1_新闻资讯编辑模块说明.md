# v4.1 新闻资讯编辑模块说明

## 📅 更新日期
2025-10-13

## 🎯 更新概述

在v4.0（8大维度专业分析版）的基础上，新增了**新闻资讯编辑模块**，允许用户在生成日报时编辑和筛选新闻内容，提供更灵活的内容控制。

---

## ✨ 新增功能

### 1. **📰 新闻资讯编辑区域**

在Streamlit界面的"编辑报告内容"部分，新增了第三个编辑模块：

```
✍️ 编辑报告内容
├─ 📝 行情描述
├─ 💡 主要观点
└─ 📰 新闻资讯 ⭐ NEW
```

**功能特点：**
- **📝 手动输入**：用户可直接输入或粘贴新闻内容
- **🤖 AI生成**：一键生成10-15条筛选后的新闻资讯
- **✂️ 自由编辑**：AI生成后可手动删减、修改或补充
- **📏 无字数限制**：支持任意数量和长度的新闻条目

---

## 🔧 技术实现

### 1. **新增函数：`ai_generate_news_summary()`**

**代码位置：** 第556-662行

**功能说明：**
使用DeepSeek AI从所有获取的新闻中筛选并整理10-15条最重要的资讯。

**输入参数：**
```python
def ai_generate_news_summary(
    commodity_name: str,      # 品种名称
    date_str: str,            # 目标日期
    news_list: list,          # 商品新闻列表
    professional_data: dict   # 8大维度专业数据（可选）
) -> str
```

**处理流程：**
```
1. 收集所有新闻源
   ├─ 商品新闻（最多15条）
   └─ 8大维度专业数据（每维度2条）

2. 构建新闻摘要
   └─ 格式：[序号] 标题 + 内容前200字 + 来源 + 日期

3. AI筛选和整理
   ├─ 相关性优先
   ├─ 时效性优先
   ├─ 重要性优先
   ├─ 去除重复
   └─ 格式统一

4. 输出格式化新闻列表
   └─ 序号. 新闻主体内容[上标]
```

**AI Prompt核心约束：**
```python
【重要约束】
1. ⚠️ 必须基于提供的真实新闻，严禁编造
2. ⚠️ 只提取新闻主体内容，不添加评论
3. ⚠️ 每条新闻保持独立，不合并
4. ⚠️ 使用上标[1][2][3]标注来源
5. ⚠️ 优先选择当天或临近日期的新闻
```

**温度参数：**
```python
temperature = 0.1  # 极低温度，确保忠实原文
max_tokens = 2000  # 支持10-15条新闻
```

---

### 2. **修改函数：`create_report_professional()`**

**代码位置：** 第1042-1076行

**新增参数：**
```python
def create_report_professional(
    custom_date_str, 
    symbol, 
    commodity_name, 
    user_description, 
    main_view,
    user_news_content=None,  # ⭐ NEW：用户编辑的新闻内容
    serper_key=None
)
```

**处理逻辑：**
```python
# 优先使用用户编辑的新闻内容
if user_news_content and user_news_content.strip():
    news_description = user_news_content
    # 提取引用用于附录
    ref_numbers = re.findall(r'\[(\d+)\]', news_description)
    if ref_numbers and serper_key:
        _, news_list = get_news_data_enhanced(...)
    else:
        news_list = []
else:
    # 如果用户未填写，自动获取
    news_description, news_list = get_news_data_enhanced(...)
```

---

### 3. **UI界面新增**

**代码位置：** 第1495-1541行

**布局结构：**
```python
st.markdown("### 📰 新闻资讯")
col_news1, col_news2 = st.columns([3, 1])

with col_news1:
    # 新闻内容编辑框（高度300px）
    news_content = st.text_area(
        "请输入新闻资讯（可自行编辑或AI生成）",
        value=default_news,
        height=300,
        key="news_content",
        placeholder="""示例格式..."""
    )

with col_news2:
    # AI生成按钮
    if st.button("📰 AI生成新闻资讯"):
        ai_news = ai_generate_news_summary(...)
        st.session_state.ai_generated_news = ai_news
        st.success("✅ 新闻资讯生成完成！")
        st.rerun()
```

**Session State变量：**
```python
st.session_state.ai_generated_news       # 存储AI生成的新闻
st.session_state.professional_data        # 存储8大维度数据
```

---

### 4. **生成日报时的处理**

**代码位置：** 第1583-1591行

**传参更新：**
```python
doc_path = create_report_professional(
    custom_date_str,
    full_contract,
    commodity_name,
    user_description,
    main_view,
    user_news_content=news_content,  # ⭐ 传入用户编辑的新闻
    serper_key=SERPER_API_KEY
)
```

**验证逻辑：**
```python
# 新闻资讯为可选项，给出提示但不强制
elif not news_content:
    st.warning("⚠️ 建议填写新闻资讯内容，或点击AI生成")
    st.info("💡 您也可以留空新闻资讯，继续生成日报")

# 允许在没有新闻的情况下生成日报（向后兼容）
if (full_contract and commodity_name and user_description and main_view):
    # 生成日报...
```

---

## 📊 使用流程

### **标准流程（推荐）**

```
1. 输入基本信息
   ├─ 选择日期
   ├─ 输入品种名称
   └─ 输入合约代码

2. 生成K线图
   └─ 自动获取市场数据和新闻

3. 编辑报告内容
   ├─ AI生成行情描述（或手动输入）
   ├─ AI生成主要观点（8大维度分析）
   └─ AI生成新闻资讯 ⭐ NEW
       ├─ 点击"AI生成新闻资讯"
       ├─ 等待10-15秒
       ├─ AI自动筛选10-15条新闻
       └─ 手动编辑、删减或补充

4. 生成完整日报
   └─ 下载Word文档
```

### **高级用法：完全自定义**

```
3. 编辑报告内容
   └─ 📰 新闻资讯
       ├─ 不点击AI生成
       ├─ 直接在文本框中输入自己的新闻
       ├─ 格式：序号. 新闻内容[引用序号]
       └─ 例如：
           1. 今日铜价大涨3%，突破80000元关口[1]
           2. 国家储备局宣布增加铜储备100万吨[2]
```

---

## 🎨 输出格式

### **Word报告中的新闻资讯部分**

```
三、市场资讯

1. 今日生猪期货主力合约收于11325元，日内下跌2.12%，创近期新低[1]

2. 全国生猪均价跌至11.19元/公斤，环比下跌0.26元，月环比下跌16.04%[2]

3. 交易所仓单数据显示，生猪仓单环比增加3000吨至15000吨，供应压力持续[3]

4. 三大猪企销售均价连续三个月下滑，反映出供给过剩格局短期难改[4]

...（10-15条）

────────────────────────────────

附录：参考文献

[1] 今日生猪期货主力合约收于11325元
    来源：财经资讯 | 日期：2025-10-10
    链接：https://example.com/news1

[2] 全国生猪均价跌至11.19元/公斤
    来源：智农通APP | 日期：2025-10-10
    链接：https://example.com/news2

...
```

---

## 🆚 v4.0 vs v4.1 对比

| 功能项 | v4.0 | v4.1 ⭐ NEW |
|--------|------|------------|
| **新闻获取** | 自动获取，不可编辑 | 支持AI生成 + 手动编辑 |
| **新闻条数** | 固定8条 | 10-15条（可调整） |
| **新闻质量** | 自动抓取，未筛选 | AI智能筛选，去重去噪 |
| **新闻来源** | 仅商品新闻 | 商品新闻 + 8大维度数据 |
| **用户控制** | ❌ 无法控制 | ✅ 完全可控 |
| **格式统一** | 可能不一致 | AI自动统一格式 |
| **相关性** | 可能不相关 | AI筛选高相关性 |

---

## 💡 AI筛选逻辑

### **5大筛选维度**

1. **相关性优先**
   - 与指定品种期货直接相关
   - 排除无关品种的新闻

2. **时效性优先**
   - 优先选择目标日期的新闻
   - 接受临近日期（±2天）
   - 排除过旧新闻

3. **重要性优先**
   - 价格变动
   - 库存/仓单变化
   - 政策发布
   - 重大事件

4. **内容完整性**
   - 保留新闻主体内容
   - 不截断关键信息
   - 去除无意义片段

5. **去重处理**
   - 相似内容只保留一条
   - 合并重复信息来源

---

## 📝 使用示例

### **示例1：标准AI生成**

**操作：**
```
1. 品种：生猪
2. 合约：LH2511
3. 日期：2025-10-10
4. 点击"生成K线图"
5. 点击"AI生成新闻资讯"
```

**AI输出（10秒后）：**
```
1. 今日生猪期货主力合约收于11325元，日内下跌2.12%，最高价11580元，最低价11320元[1]

2. 全国生猪均价跌至11.19元/公斤，与昨日相比下跌0.26元/公斤，月环比下跌16.04%，同比下跌36.4%[2]

3. 截至10月10日收盘，期货市场生猪主力合约已跌至11320元/吨，较去年8月19010元/吨的高点跌去超40%[3]

4. [库存] 交易所仓单数据显示，生猪仓单环比增加3000吨至15000吨，供应压力持续[4]

5. [基差] 生猪期现基差为-105元/吨，期货贴水现货，反映市场预期偏弱[5]

...（共15条）
```

**用户可编辑：**
```
✂️ 删除不需要的条目
✏️ 修改内容表述
➕ 添加自己的新闻
```

---

### **示例2：完全自定义**

**操作：**
```
1-4. 同示例1
5. 不点击AI生成
6. 直接在文本框输入：
```

**自定义内容：**
```
1. 今日铜价强势反弹，LME铜收涨2.5%，突破9500美元关口[1]

2. 国家储备局宣布本月将投放10万吨铜储备，缓解市场供应紧张[2]

3. 智利第二大铜矿因罢工停产，影响月产量约5万吨，加剧全球供应担忧[3]

4. 中国10月铜进口量同比增长15%，达到52万吨，创年内新高[4]

5. 新能源汽车需求强劲，铜消费预计全年增长8%，超市场预期[5]
```

**生成日报：**
- Word文档将使用您自定义的新闻内容
- 附录中会列出引用[1][2][3][4][5]的来源

---

## ⚙️ 配置参数

### **AI生成参数**

```python
# DeepSeek API配置
model: "deepseek-chat"
temperature: 0.1          # 极低，确保忠实原文
max_tokens: 2000          # 支持10-15条新闻

# 新闻源配置
商品新闻: 最多15条
专业数据: 每维度2条
总计: 最多31条输入 → 筛选出10-15条
```

### **筛选权重（AI内置）**

```
相关性：30%
时效性：25%
重要性：25%
完整性：10%
独特性：10%
```

---

## 🐛 常见问题

### Q1: AI生成的新闻条数少于10条？

**原因：**
- 相关新闻较少
- 日期筛选过严
- 去重后剩余较少

**解决：**
- 手动补充新闻
- 或接受AI输出的条数

---

### Q2: AI生成失败或超时？

**原因：**
- DeepSeek API网络问题
- 输入新闻数据过少
- API密钥错误

**解决：**
```
1. 检查网络连接
2. 检查API密钥是否正确
3. 等待10-15秒再点击
4. 或手动输入新闻内容
```

---

### Q3: 附录中的引用链接不正确？

**原因：**
- 用户自定义新闻时引用序号与原始新闻不匹配

**解决：**
- 使用AI生成（自动匹配）
- 或手动确保引用序号一致

---

## 🎓 最佳实践

### ✅ 推荐做法

1. **第一次使用**
   - 先点击"AI生成新闻资讯"
   - 查看AI筛选的结果
   - 理解格式和内容标准

2. **日常使用**
   - AI生成 + 人工审核编辑
   - 删除不相关的条目
   - 补充重要的自有信息

3. **高级用户**
   - 混合使用：部分AI生成，部分自定义
   - 保持格式一致：序号. 内容[引用]

---

### ❌ 避免做法

1. **不要完全依赖AI**
   - AI可能遗漏重要信息
   - 需要人工审核和补充

2. **不要忽略格式**
   - 保持"序号. 内容[引用]"格式
   - 便于生成附录

3. **不要编造信息**
   - 所有新闻必须真实
   - 可追溯来源

---

## 📈 性能优化

### **生成速度**

```
AI生成新闻资讯：
- 搜索新闻：5-8秒（已在"生成K线图"时完成）
- 搜索8大维度数据：20-30秒（已在"AI生成主要观点"时完成）
- AI筛选整理：5-10秒
- 总计：5-10秒（如果之前的步骤已完成）
```

### **优化建议**

```
按顺序点击按钮：
1. 生成K线图（获取基础数据）
2. AI生成主要观点（获取专业数据）
3. AI生成新闻资讯（复用前面的数据）
   └─ 这样最快，只需5-10秒
```

---

## 📜 更新记录

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v4.0 | 2025-10-13 | 8大维度专业分析 |
| **v4.1** | **2025-10-13** | **新增新闻资讯编辑模块** |

---

## 🔗 相关文档

- [README.md](README.md) - 完整项目说明
- [v4.0_8大维度专业分析说明.md](v4.0_8大维度专业分析说明.md) - 8大维度分析详解
- [v3.3_引用格式优化说明.md](v3.3_引用格式优化说明.md) - 引用格式说明
- [文件权限问题修复说明.md](文件权限问题修复说明.md) - 文件权限问题解决

---

**✅ v4.1更新完成！新闻资讯现在完全可控，支持AI生成和人工编辑！**

Created by 7haoge (953534947@qq.com)

